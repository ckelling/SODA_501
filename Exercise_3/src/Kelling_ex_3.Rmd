---
title: "Kelling Exercise 3"
author: "Claire Kelling"
date: "March 30, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Read in Data
```{r}
library(dplyr)
setwd("C:/Users/ckell/OneDrive/Penn State/2017-2018/01_Spring/SODA_501/SODA_501/Exercise_3")
dat <- read.csv("data/CentreCountyPrecinctResults2016GeneralElection.txt")
```


# Calculations

## Total Vote
First, I will calculate the Total Vote for each precinct.
```{r}
tot_vote <- dat[which(dat$Contest == "BALLOTS CAST - TOTAL"), c(5,6,13)]
colnames(tot_vote) <- c("PrecNo", "PrecName", "Tot")

```

## Two-party Vote
Now, I will calculate the share of the two-party vote for the following:
* President
* US Senate
* Attorney General
* Auditor General
* State Treasurer 

```{r}
agg_dat <- dat %>% filter(Contest %in% c("PRESIDENTIAL ELECTORS", "UNITED STATES SENATOR",
                                    "ATTORNEY GENERAL", "AUDITOR GENERAL",
                                    "STATE TREASURER")) %>% #use only our interested races
  filter(Party %in% c("DEMOCRATIC", "REPUBLICAN")) #use only our two-party vote

two_vote_tot <- agg_dat %>%  
  group_by(PrecName, Contest) %>% #grouping by the precinct and contest
  dplyr::summarise(vote_tot = sum(Count)) #calcuating the total vote

dem_vote_tot <- agg_dat %>% 
  filter(Party %in% c("DEMOCRATIC")) %>% #use only democratic vote
  group_by(PrecName, Contest) %>% #grouping by the precinct and contest
  dplyr::summarise(vote_dem = sum(Count)) #calcuating the total vote

share_df <- left_join(dem_vote_tot, two_vote_tot) #combining the two data frames
share_df$D2 <- round(100*share_df$vote_dem/share_df$vote_tot,2) #calculating the share

#now, I would like to make each row a precinct, 
#   instead of each row a race within a precinct
share_df <- share_df[,-c(3,4)]
share_df <- share_df %>% spread(Contest, D2)

colnames(share_df) <- c("PrecName", "D2Att", "D2Aud",
                        "D2Pre", "D2Tre", "D2Sen")

share_df <- left_join(tot_vote, share_df)

```


## Rolloff
Now, I will calculate the rolloff for each of these races:
* President
* US Senate
* Attorney General
* Auditor General
* State Treasurer 

Ballot rolloff is the percentage of voters who voted for President, but did not vote for the particular
office. That is: 100 * ((1 - total votes cast for the office)/ (total votes cast for President)).

```{r}
tot_pres_vote <- dat %>% filter(Contest %in% c("PRESIDENTIAL ELECTORS")) %>% #only president
  group_by(PrecName) %>% #group by precinct and contest
  dplyr::summarise(pres_vote = sum(Count)) #calcuating the total vote

tot_vote <- dat %>% filter(Contest %in% c("UNITED STATES SENATOR",
                                    "ATTORNEY GENERAL", "AUDITOR GENERAL",
                                    "STATE TREASURER")) %>% 
  group_by(PrecName, Contest) %>% #grouping by the precinct and contest
  dplyr::summarise(vote_race = sum(Count)) #calcuating the total vote


ro_dat <- left_join(tot_vote, tot_pres_vote)
ro_dat$ro <- round(100*(1-(ro_dat$vote_race/ro_dat$pres_vote)), 2)

#now, I would like to make each row a precinct, 
#   instead of each row a race within a precinct
ro_dat <- ro_dat[,-c(3,4)]
ro_dat <- ro_dat %>% spread(Contest, ro)

colnames(ro_dat) <- c("PrecName", "ROAtt", "ROAud",
                        "ROTre", "ROSen")

full_df <- left_join(share_df, ro_dat)

```


## Cleaning up final dataset
Now, I would like to clean up the dataset as follows:
* Make the PrecName variable without the numbers as the beginning
* Order the variables correctly

```{r}
#Make the PrecName variable without the numbers as the beginning
full_df$PrecName <- substring(full_df$PrecName, 4)

#Make proper ordering of columns
full_df <- full_df[,c(1:3, 6, 8, 4, 5, 7, 12, 9, 10, 11)]

```

## Write the csv file
```{r}
setwd("C:/Users/ckell/OneDrive/Penn State/2017-2018/01_Spring/SODA_501/SODA_501/Exercise_3")
write.csv(full_df, file = "output/Exercise3.csv")
```

